// ============================================================================
// FastOS Kernel - Entry Point
// ============================================================================
// GPU-First / Binary-First Operating System (64-bit)
// Stack: ADead-BIB + Rust + wgpu
//
// Author: Eddi Andre√© Salazar Matos üáµüá™
// ============================================================================

#![no_std]
#![no_main]

mod adead_bib;
mod gpu;
mod syscall;
mod loader;
mod mouse;
mod desktop;

use bootloader_api::{entry_point, BootInfo};
use core::panic::PanicInfo;
use core::arch::asm;
use gpu::GpuDriver;
use desktop::Desktop;

entry_point!(kernel_main);

fn kernel_main(boot_info: &'static mut BootInfo) -> ! {
    if let Some(fb) = boot_info.framebuffer.as_mut() {
        let info = fb.info();
        let buffer = fb.buffer_mut();
        let w = info.width;
        let h = info.height;
        let pitch = info.stride * info.bytes_per_pixel;
        let bpp = info.bytes_per_pixel;
        
        // Inicializar driver GPU
        GpuDriver::init(buffer.as_mut_ptr(), w, h, pitch, bpp);
        
        // Inicializar mouse
        mouse::init(w as i32, h as i32);
        
        // Crear escritorio
        let mut desktop = Desktop::new(w as i32, h as i32);
        
        // Loop principal del escritorio
        loop {
            // Leer datos del mouse (polling)
            poll_mouse();
            
            // Actualizar l√≥gica
            desktop.update();
            
            // Dibujar
            if let Some(gpu) = GpuDriver::get() {
                desktop.draw(gpu);
            }
            
            // Peque√±a pausa
            for _ in 0..50000 {
                unsafe { asm!("nop"); }
            }
        }
    }
    
    loop { unsafe { asm!("hlt"); } }
}

/// Polling del mouse PS/2
fn poll_mouse() {
    unsafe {
        // Verificar si hay datos disponibles
        let status: u8;
        asm!("in al, dx", out("al") status, in("dx") 0x64u16, options(nomem, nostack));
        
        if status & 0x21 == 0x21 {  // Datos del mouse disponibles
            let data: u8;
            asm!("in al, dx", out("al") data, in("dx") 0x60u16, options(nomem, nostack));
            mouse::handle_byte(data);
        }
    }
}

#[inline]
fn put_pixel(buf: &mut [u8], pitch: usize, bpp: usize, x: usize, y: usize, color: u32) {
    let off = y * pitch + x * bpp;
    if off + 2 < buf.len() {
        buf[off] = (color & 0xFF) as u8;
        buf[off + 1] = ((color >> 8) & 0xFF) as u8;
        buf[off + 2] = ((color >> 16) & 0xFF) as u8;
    }
}

fn draw_rect(buf: &mut [u8], pitch: usize, bpp: usize, x: usize, y: usize, w: usize, h: usize, color: u32) {
    for dy in 0..h {
        for dx in 0..w {
            put_pixel(buf, pitch, bpp, x + dx, y + dy, color);
        }
    }
}

fn draw_centered_text(buf: &mut [u8], pitch: usize, bpp: usize, width: usize, text: &str, y: usize, color: u32) {
    let x = (width.saturating_sub(text.len() * 9)) / 2;
    let mut cx = x;
    for c in text.bytes() {
        draw_char(buf, pitch, bpp, cx, y, c, color);
        cx += 9;
    }
}

fn draw_char(buf: &mut [u8], stride: usize, bpp: usize, x: usize, y: usize, c: u8, color: u32) {
    let bitmap = get_font(c);
    for (row, &bits) in bitmap.iter().enumerate() {
        for col in 0..8 {
            if bits & (0x80 >> col) != 0 {
                put_pixel(buf, stride, bpp, x + col, y + row, color);
            }
        }
    }
}

fn get_font(c: u8) -> [u8; 8] {
    match c {
        b'A' => [0x18,0x3C,0x66,0x7E,0x66,0x66,0x66,0x00],
        b'B' => [0x7C,0x66,0x7C,0x66,0x66,0x66,0x7C,0x00],
        b'C' => [0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00],
        b'D' => [0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00],
        b'E' => [0x7E,0x60,0x7C,0x60,0x60,0x60,0x7E,0x00],
        b'F' => [0x7E,0x60,0x7C,0x60,0x60,0x60,0x60,0x00],
        b'G' => [0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0x00],
        b'H' => [0x66,0x66,0x7E,0x66,0x66,0x66,0x66,0x00],
        b'I' => [0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00],
        b'K' => [0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00],
        b'L' => [0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00],
        b'M' => [0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00],
        b'N' => [0x66,0x76,0x7E,0x6E,0x66,0x66,0x66,0x00],
        b'O' => [0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00],
        b'P' => [0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00],
        b'R' => [0x7C,0x66,0x66,0x7C,0x6C,0x66,0x66,0x00],
        b'S' => [0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00],
        b'T' => [0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00],
        b'U' => [0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00],
        b'V' => [0x66,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00],
        b'W' => [0x63,0x63,0x6B,0x7F,0x77,0x63,0x63,0x00],
        b'a' => [0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00],
        b'b' => [0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00],
        b'c' => [0x00,0x00,0x3C,0x60,0x60,0x60,0x3C,0x00],
        b'd' => [0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00],
        b'e' => [0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00],
        b'f' => [0x1C,0x30,0x7C,0x30,0x30,0x30,0x30,0x00],
        b'g' => [0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C],
        b'h' => [0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00],
        b'i' => [0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00],
        b'k' => [0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00],
        b'l' => [0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00],
        b'm' => [0x00,0x00,0x76,0x7F,0x6B,0x63,0x63,0x00],
        b'n' => [0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00],
        b'o' => [0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00],
        b'p' => [0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60],
        b'r' => [0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00],
        b's' => [0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00],
        b't' => [0x30,0x30,0x7C,0x30,0x30,0x30,0x1C,0x00],
        b'u' => [0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00],
        b'v' => [0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00],
        b'w' => [0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00],
        b'x' => [0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00],
        b'y' => [0x00,0x00,0x66,0x66,0x3E,0x06,0x3C,0x00],
        b'z' => [0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00],
        b'0' => [0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00],
        b'1' => [0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00],
        b'6' => [0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00],
        b'4' => [0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00],
        b' ' => [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
        b'.' => [0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00],
        b':' => [0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00],
        b'-' => [0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00],
        b'/' => [0x02,0x06,0x0C,0x18,0x30,0x60,0x40,0x00],
        b'@' => [0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x3C,0x00],
        b'!' => [0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x00],
        b'(' => [0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00],
        b')' => [0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00],
        b'[' => [0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00],
        b']' => [0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00],
        b'+' => [0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00],
        _ => [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    }
}

#[panic_handler]
fn panic(_: &PanicInfo) -> ! {
    loop { unsafe { asm!("hlt"); } }
}
